#!/bin/sh

# AI Companion Pre-Commit Hook
# Runs: lint-staged, Secret scanning
# Blocks commits with: API keys, secrets, lint errors

echo "ğŸ” Running pre-commit checks..."
echo ""

# Track if any check fails
FAILED=0

# 1. Secret Scanning with git-secrets (STRICT)
echo "ğŸ” Checking for secrets..."
if command -v git-secrets &> /dev/null; then
    if git secrets --scan 2>/dev/null; then
        echo "   âœ… No secrets detected"
    else
        SECRETS_EXIT=$?
        if [ $SECRETS_EXIT -eq 1 ]; then
            echo "âŒ SECRETS DETECTED! Commit blocked."
            echo "ğŸ’¡ Move API keys to .env file (which is gitignored)"
            echo ""
            FAILED=1
        fi
    fi
else
    echo "   âš ï¸  git-secrets not installed. Skipping secret scan."
    echo "   Install git-secrets: https://github.com/awslabs/git-secrets"
fi

# 2. Run lint-staged (runs ESLint and flake8 on staged files only)
echo "ğŸ“ Running linters on staged files..."
if ! npx lint-staged; then
    echo ""
    echo "âŒ Linting failed!"
    echo "ğŸ’¡ Some issues were auto-fixed. Run 'git status' and try again."
    echo ""
    FAILED=1
fi

# Final result
if [ $FAILED -eq 1 ]; then
    echo ""
    echo "â›” Commit blocked! Fix the issues above."
    echo ""
    echo "Emergency bypass (requires admin approval):"
    echo "   Contact: admin@company.com with justification"
    echo ""
    exit 1
else
    echo ""
    echo "âœ… All checks passed!"
    echo ""
    exit 0
fi
